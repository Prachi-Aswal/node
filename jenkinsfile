pipeline {

       environment {
       
           AWS_ACCOUNT_ID="437144803032"
           AWS_DEFAULT_REGION="us-east-2"
           IMAGE_REPO_NAME="prachi-aswal-nodejs"
           IMAGE_TAG= "latest"
           REPOSITORY_URI = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${IMAGE_REPO_NAME}"
           }
          





agent any
tools {
    nodejs 'nodejs'
    }
stages
{

        stage('Git checkout')

         {
             steps
                {
                    git branch: 'master',
                    credentialsId: '973d1a99-2328-4225-af19-6cfd4b511630',
                    url: 'https://github.com/Prachi-Aswal/simple-node-js-react-npm-app.git'

                  }
              }




stage('Build')
{
          steps

                {
                    sh "npm install"
                  }

}


stage('Test')

              {
                       steps
                             {

                       sh "npm run test"
                              }
                }
stage('Logging into AWS ECR') {
steps {
script {
sh "aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
}

}
}



stage('Building image') {
steps {
script {
dockerImage = docker.build "${IMAGE_REPO_NAME}:${IMAGE_TAG}"
sh "docker tag ${IMAGE_REPO_NAME}:${IMAGE_TAG} ${REPOSITORY_URI}:$IMAGE_TAG"
}
}
}

stage('Pushing to ECR') {
steps {
script {
docker.withRegistry('437144803032.dkr.ecr.us-east-2.amazonaws.com', 'ecr:us-east-2:ecr-eks') {
sh "echo ${REPOSITORY_URI}"
sh "echo ${IMAGE_TAG}"
docker.image('437144803032.dkr.ecr.us-east-2.amazonaws.com/prachi-aswal-nodejs').push('latest')

}
}
}
}
}
}






